### Setup
rm(list=ls())
windows <- Sys.info()[1][["sysname"]]=="Windows"
root <- ifelse(windows,"J:/","/home/j/")
user <- ifelse(windows, Sys.getenv("USERNAME"), Sys.getenv("USER"))
code.dir <- paste0(ifelse(windows, "H:", paste0("/homes/", user)), "/HIV/")

## Packages
library(data.table); library(survey)

## Arguments
args <- commandArgs(trailingOnly = TRUE)
if(length(args) > 0) {
	run.name <- args[1]
} else {
	run.name <- '190503_all'
}

### Paths
out.dir <- paste0("/ihme/hiv/epp_input/gbd19/", run.name, "/")
dir.create(out.dir, showWarnings = F)
out.path <- paste0(out.dir, "prev_surveys.csv")
supp.survey.path <- paste0(root, "WORK/04_epi/01_database/02_data/hiv/04_models/gbd2015/02_inputs/supplement_survey_data_2017.csv")

### Functions
library(mortdb, lib = "/home/j/WORK/02_mortality/shared/r")

### Tables
loc.table <- data.table(get_locations(hiv_metadata = T))

### Code
## GBD locs
gbd.locs <- loc.table$ihme_loc_id

#bring in geospatial microdata
##TODO update to newest geospatial surveys
geos_dir <- paste0("/ihme/limited_use/LIMITED_USE/LU_GEOSPATIAL/geo_matched/hiv_gbd/Archive/")
versions <- grep("[[:digit:]]*\\.[[:digit:]]*\\.[[:digit:]]*", list.dirs(geos_dir, full.names=F), value=T)
newest <- versions[which.max(as.Date(versions, format="%m.%d.%y"))]
load(paste0('/ihme/limited_use/LIMITED_USE/LU_GEOSPATIAL/geo_matched/hiv_gbd/Archive/03.15.18/2018_03_15.Rdata'))
setnames(gbd_all, "country", "iso3")
data3 <- gbd_all[between(age_year, 15, 49) & !is.na(iso3) & !is.na(hiv_test) & !is.na(hiv_weight),]
# Kenya
data3[grepl("KEN", iso3) & !(admin_2_id == "KEN" | admin_2_id == "" | is.na(admin_2_id)), iso3 := admin_2_id]
data3 <- data3[iso3 != "KEN"]

# South Africa
data3[grepl("ZAF", iso3) & !is.na(admin_1_id), iso3 := admin_1_id]

# Ethiopia
data3[grepl("ETH", iso3) & !is.na(admin_1_id), iso3 := admin_1_id]

# India
data3[grepl("IND", iso3) & !is.na(admin_1_id), iso3 := admin_1_id]

# Repeat India states U/R
ind.copy <- copy(data3[grepl("IND", iso3)])
ind.copy[, iso3 := admin_1_urban_id]
data3 <- rbind(data3, ind.copy)
data3[,loc_year := paste0(iso3,"_",year)] 

## Nigeria
## TODO: Update Ubcov extraction to actually match admin_1_id
ngadata <- data3[grepl('NGA', iso3)]
data3 <- data3[!grepl('NGA', iso3)]
ngadata[, temp := tolower(admin_1)]
ngadata[, temp := paste0(toupper(substr(temp, 1, 1)), substr(temp, 2, length(temp)))]
ngadata[temp %in% c('Cross river', 'Cross-river'), temp := 'Cross River']
ngadata[temp %in% c('Fct abuja', 'Fct-abuja'), temp := 'FCT (Abuja)']
ngadata[temp %in% c('Akwa-ibom', 'Akwa ibom'), temp := 'Akwa Ibom']
nga.table <- loc.table[grepl('NGA_', ihme_loc_id),.(ihme_loc_id, temp = location_name)]
ngadata <- merge(ngadata, nga.table, by = 'temp', all.x = T)
ngadata[!is.na(temp), admin_1_id := ihme_loc_id]
ngadata[!is.na(temp), iso3 := admin_1_id]
ngadata[,c('temp', 'ihme_loc_id') := NULL]
data3 <- rbind(data3, ngadata, use.names = T)

#bring in report data (not extracted yet)
supp.survey <- fread(supp.survey.path)[iso3 %in% gbd.locs & outlier == 0]
supp.survey[, outlier := NULL]

## process microdata
#need this option unfortunately
options(survey.lonely.psu="adjust")
data4 <- rbindlist(
	lapply( unique(data3$loc_year),
		function(loc.year){
			print(loc.year)
			data5 <- data3[loc_year == loc.year]
			loc <- unique(data5$iso3)
			if(all(data5$hiv_test == 0)) {
				# impute a half positive observation to get uncertainty for 0 prevalence
				hold <- copy(data5[1,])
				hold$hiv_test <- 0.5
				data5 <- rbind(data5, hold)
			}
			if(nrow(data5[is.na(strata),]) > 0){
				print(paste0((nrow(data5[is.na(strata),])/nrow(data5))*100,"% missing strata for ",loc.year))
				if(nrow(data5[!is.na(strata),]) == 0) {
					data6 <- data5
					s <- svydesign(ids = ~psu, weights = ~hiv_weight,data = data6)
				} else {
					data6 <- data5[!is.na(strata),]
					s <- svydesign(ids = ~psu, strata = ~strata, weights = ~hiv_weight,data = data6,check.strata = TRUE)	                
				}
				t <- svymean(~hiv_test,s)
				data5 <- data5[,list(year = median(int_year), prev = weighted.mean(hiv_test, hiv_weight, na.rm = T), n = .N),
				by='iso3,nid,survey_name']
				d <- data.table(iso3 = loc, year = data5[,"year", with = F][[1]],prev =data5[,"prev", with = F][[1]], se = SE(t)[[1]], n = nrow(data6)  )
				return(d)
			} else { 
				if(length(unique(data5$psu)) == 1) {
					data6 <- data5
					s <- svydesign(id = ~hh_id, strata = ~strata, weights = ~hiv_weight,data = data6)
				} else {
					s <- svydesign(ids = ~psu, strata = ~strata, weights = ~hiv_weight, data = data5, check.strata = TRUE)
				}	          	
				t <- svymean(~hiv_test,s)
				data13 <- data5[,list(year = median(int_year), prev=weighted.mean(hiv_test, hiv_weight, na.rm=T), n=.N),
				by='iso3,nid,survey_name']
				d <- data.table(iso3 = loc, year = data13[,"year", with = F][[1]],prev =coef(t)[[1]], se = SE(t)[[1]], n = nrow(data5)  )
				return(d)
			}

		}
	)
)
nid.dt <- unique(data3[, .(int_year, iso3, nid)])
nid.dt[, year := as.numeric(int_year)]
temp <- merge(data4, nid.dt, by = c("year", "iso3"), all.x = T)
out.dt <- rbind(temp, supp.survey, fill = T)

# Check for duplicates
loc.years <- data.table(melt(table(out.dt[, .(iso3, year)])))
loc.years[value == 2]

# Outlier surveys
out.dt <- out.dt[!(grepl("ZAF", iso3) & year %in% c(2002, 2008))]
out.dt <- out.dt[!(iso3 %in% c("KEN_35623", "KEN_35662") & year == 2008)]

write.csv(out.dt, out.path, row.names = F)


### End

### fix missing sample size for RWA and STP
prev_survey<- as.data.table(read.csv("/share/hiv/epp_input/gbd20/prev_surveys.csv"))
prev_survey<- prev_survey[!(iso3=="RWA"&year== 2018 & !(is.na(n))&use=="TRUE"&sex_id %in% c(1,2))]
View(prev_survey[iso3=="RWA"])
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==15, n := 3071]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==20, n := 2217]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==25, n := 1869]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==30, n := 1777]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==35, n := 1567]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==40, n := 950]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==45, n := 716]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==50, n := 594]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==55, n := 516]
prev_survey[iso3=="RWA"&sex_id==1&year==2018&age_year==60, n := 503]

prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==15, n := 3347]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==20, n := 2723]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==25, n := 2349]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==30, n := 2120]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==35, n := 1770]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==40, n := 1342]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==45, n := 963]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==50, n := 812]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==55, n := 728]
prev_survey[iso3=="RWA"&sex_id==2&year==2018&age_year==60, n := 658]

View(prev_survey[iso3=="STP"])
prev_survey[iso3=="STP"&sex_id==1&year==2014&age_year==15, n := 577]
prev_survey[iso3=="STP"&sex_id==1&year==2014&age_year==20, n := 356]
prev_survey[iso3=="STP"&sex_id==1&year==2014&age_year==25, n := 342]
prev_survey[iso3=="STP"&sex_id==1&year==2014&age_year==30, n := 327]
prev_survey[iso3=="STP"&sex_id==1&year==2014&age_year==35, n := 271]
prev_survey[iso3=="STP"&sex_id==1&year==2014&age_year==40, n := 170]
prev_survey[iso3=="STP"&sex_id==1&year==2014&age_year==45, n := 158]

prev_survey[iso3=="STP"&sex_id==2&year==2014&age_year==15, n := 595]
prev_survey[iso3=="STP"&sex_id==2&year==2014&age_year==20, n := 408]
prev_survey[iso3=="STP"&sex_id==2&year==2014&age_year==25, n := 422]
prev_survey[iso3=="STP"&sex_id==2&year==2014&age_year==30, n := 379]
prev_survey[iso3=="STP"&sex_id==2&year==2014&age_year==35, n := 296]
prev_survey[iso3=="STP"&sex_id==2&year==2014&age_year==40, n := 247]
prev_survey[iso3=="STP"&sex_id==2&year==2014&age_year==45, n := 171]

prev_survey[iso3=="STP"&year==2014&age_year != "15-49",se := (prev*(1-prev)/n)^0.5]
summary(prev_survey[iso3=="STP"])
write.csv(prev_survey, "/share/hiv/epp_input/gbd20/prev_surveys.csv")
